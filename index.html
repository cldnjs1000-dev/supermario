<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ìŠˆí¼ ë§ˆë¦¬ì˜¤ ê²Œì„</title>
    <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-database-compat.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap');
        
        * {
            font-family: 'Press Start 2P', cursive;
        }
        
        #gameCanvas {
            image-rendering: pixelated;
            image-rendering: crisp-edges;
        }
        
        .mario-btn {
            background: linear-gradient(180deg, #e52521 0%, #8b0000 100%);
            border: 4px solid #000;
            box-shadow: 4px 4px 0 #000;
            transition: all 0.1s;
        }
        
        .mario-btn:hover {
            transform: translate(2px, 2px);
            box-shadow: 2px 2px 0 #000;
        }
        
        .mario-btn:active {
            transform: translate(4px, 4px);
            box-shadow: 0 0 0 #000;
        }
        
        .pixel-border {
            border: 4px solid #000;
            box-shadow: 4px 4px 0 #000;
        }
        
        @keyframes jump {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }
        
        .jumping {
            animation: jump 0.5s ease-in-out infinite;
        }
        
        .cloud {
            animation: float 3s ease-in-out infinite;
        }
        
        @keyframes float {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }
    </style>
</head>
<body class="bg-sky-400 min-h-screen">
    <!-- ë¡œê·¸ì¸ í™”ë©´ -->
    <div id="loginScreen" class="min-h-screen flex items-center justify-center p-4">
        <div class="bg-yellow-400 pixel-border p-8 max-w-md w-full text-center">
            <h1 class="text-2xl md:text-3xl text-red-600 mb-2">SUPER</h1>
            <h1 class="text-3xl md:text-4xl text-red-600 mb-8">MARIO</h1>
            
            <!-- ë§ˆë¦¬ì˜¤ ìºë¦­í„° -->
            <div class="text-6xl mb-8 jumping">ğŸ„</div>
            
            <div id="authContainer">
                <input type="email" id="emailInput" placeholder="ì´ë©”ì¼" 
                    class="w-full p-3 mb-4 text-xs pixel-border bg-white">
                <input type="password" id="passwordInput" placeholder="ë¹„ë°€ë²ˆí˜¸" 
                    class="w-full p-3 mb-4 text-xs pixel-border bg-white">
                
                <button onclick="login()" class="mario-btn text-white px-6 py-3 text-xs w-full mb-3">
                    ë¡œê·¸ì¸
                </button>
                <button onclick="register()" class="mario-btn text-white px-6 py-3 text-xs w-full mb-3" 
                    style="background: linear-gradient(180deg, #4CAF50 0%, #2E7D32 100%);">
                    íšŒì›ê°€ì…
                </button>
                <button onclick="guestLogin()" class="mario-btn text-white px-6 py-3 text-xs w-full"
                    style="background: linear-gradient(180deg, #2196F3 0%, #1565C0 100%);">
                    ê²ŒìŠ¤íŠ¸ í”Œë ˆì´
                </button>
            </div>
            
            <p id="authMessage" class="text-xs mt-4 text-red-800"></p>
        </div>
    </div>

    <!-- ë©”ì¸ ë©”ë‰´ -->
    <div id="menuScreen" class="min-h-screen flex items-center justify-center p-4 hidden">
        <div class="bg-yellow-400 pixel-border p-8 max-w-md w-full text-center">
            <h1 class="text-2xl text-red-600 mb-4">SUPER MARIO</h1>
            <p id="welcomeText" class="text-xs mb-6">í™˜ì˜í•©ë‹ˆë‹¤!</p>
            
            <div class="space-y-4">
                <button onclick="startGame()" class="mario-btn text-white px-6 py-4 text-sm w-full">
                    ğŸ® ê²Œì„ ì‹œì‘
                </button>
                <button onclick="showLeaderboard()" class="mario-btn text-white px-6 py-4 text-sm w-full"
                    style="background: linear-gradient(180deg, #FFD700 0%, #B8860B 100%);">
                    ğŸ† ìˆœìœ„í‘œ
                </button>
                <button onclick="showHowToPlay()" class="mario-btn text-white px-6 py-4 text-sm w-full"
                    style="background: linear-gradient(180deg, #4CAF50 0%, #2E7D32 100%);">
                    ğŸ“– ê²Œì„ ë°©ë²•
                </button>
                <button onclick="logout()" class="mario-btn text-white px-6 py-4 text-sm w-full"
                    style="background: linear-gradient(180deg, #666 0%, #333 100%);">
                    ğŸšª ë¡œê·¸ì•„ì›ƒ
                </button>
            </div>
            
            <div class="mt-6 p-4 bg-white pixel-border">
                <p class="text-xs">ìµœê³  ì ìˆ˜: <span id="myBestScore">0</span></p>
            </div>
        </div>
    </div>

    <!-- ê²Œì„ í™”ë©´ -->
    <div id="gameScreen" class="min-h-screen flex flex-col items-center justify-center p-4 hidden">
        <div class="bg-black pixel-border p-2 mb-4">
            <div class="flex justify-between text-white text-xs mb-2 px-2">
                <span>ì ìˆ˜: <span id="scoreDisplay">0</span></span>
                <span>ì½”ì¸: <span id="coinDisplay">0</span></span>
                <span>ìƒëª…: <span id="lifeDisplay">3</span></span>
            </div>
            <canvas id="gameCanvas" width="800" height="400"></canvas>
        </div>
        
        <!-- ëª¨ë°”ì¼ ì»¨íŠ¸ë¡¤ -->
        <div class="flex gap-4 md:hidden">
            <button id="leftBtn" class="mario-btn text-white px-8 py-4 text-xl">â—€</button>
            <button id="jumpBtn" class="mario-btn text-white px-8 py-4 text-xl"
                style="background: linear-gradient(180deg, #4CAF50 0%, #2E7D32 100%);">â–²</button>
            <button id="rightBtn" class="mario-btn text-white px-8 py-4 text-xl">â–¶</button>
        </div>
        
        <p class="text-white text-xs mt-4 hidden md:block">ë°©í–¥í‚¤ë¡œ ì´ë™, ìŠ¤í˜ì´ìŠ¤ë°”ë¡œ ì í”„</p>
    </div>

    <!-- ìˆœìœ„í‘œ í™”ë©´ -->
    <div id="leaderboardScreen" class="min-h-screen flex items-center justify-center p-4 hidden">
        <div class="bg-yellow-400 pixel-border p-8 max-w-lg w-full">
            <h2 class="text-xl text-red-600 text-center mb-6">ğŸ† TOP 10 ğŸ†</h2>
            
            <div id="leaderboardList" class="space-y-2 mb-6 max-h-96 overflow-y-auto">
                <!-- ìˆœìœ„ ëª©ë¡ -->
            </div>
            
            <button onclick="showMenu()" class="mario-btn text-white px-6 py-3 text-xs w-full">
                ëŒì•„ê°€ê¸°
            </button>
        </div>
    </div>

    <!-- ê²Œì„ ë°©ë²• í™”ë©´ -->
    <div id="howToPlayScreen" class="min-h-screen flex items-center justify-center p-4 hidden">
        <div class="bg-yellow-400 pixel-border p-8 max-w-lg w-full">
            <h2 class="text-xl text-red-600 text-center mb-6">ğŸ“– ê²Œì„ ë°©ë²•</h2>
            
            <div class="bg-white pixel-border p-4 mb-6 text-xs leading-relaxed space-y-4">
                <p>ğŸ® <strong>ì¡°ì‘ë²•</strong></p>
                <p>â† â†’ : ì¢Œìš° ì´ë™</p>
                <p>ìŠ¤í˜ì´ìŠ¤ë°” : ì í”„</p>
                <p class="mt-4">ğŸ¯ <strong>ëª©í‘œ</strong></p>
                <p>ì½”ì¸ì„ ëª¨ìœ¼ê³  ì ì„ í”¼í•´ ìµœëŒ€í•œ ë©€ë¦¬ ê°€ì„¸ìš”!</p>
                <p class="mt-4">âš ï¸ <strong>ì£¼ì˜</strong></p>
                <p>ì (êµ¼ë°”)ì„ ë°Ÿìœ¼ë©´ ì²˜ì¹˜!</p>
                <p>ì˜†ì—ì„œ ë¶€ë”ªíˆë©´ ìƒëª… -1</p>
                <p>êµ¬ë©ì´ì— ë¹ ì§€ë©´ ê²Œì„ ì˜¤ë²„!</p>
            </div>
            
            <button onclick="showMenu()" class="mario-btn text-white px-6 py-3 text-xs w-full">
                ëŒì•„ê°€ê¸°
            </button>
        </div>
    </div>

    <!-- ê²Œì„ ì˜¤ë²„ í™”ë©´ -->
    <div id="gameOverScreen" class="min-h-screen flex items-center justify-center p-4 hidden">
        <div class="bg-yellow-400 pixel-border p-8 max-w-md w-full text-center">
            <h2 class="text-2xl text-red-600 mb-6">GAME OVER</h2>
            
            <div class="bg-white pixel-border p-4 mb-6">
                <p class="text-xs mb-2">ìµœì¢… ì ìˆ˜</p>
                <p class="text-2xl text-red-600" id="finalScore">0</p>
                <p class="text-xs mt-2">ì½”ì¸: <span id="finalCoins">0</span></p>
            </div>
            
            <div class="space-y-3">
                <button onclick="startGame()" class="mario-btn text-white px-6 py-3 text-xs w-full">
                    ë‹¤ì‹œ í•˜ê¸°
                </button>
                <button onclick="showMenu()" class="mario-btn text-white px-6 py-3 text-xs w-full"
                    style="background: linear-gradient(180deg, #666 0%, #333 100%);">
                    ë©”ë‰´ë¡œ
                </button>
            </div>
        </div>
    </div>

    <script>
        // â¬‡ï¸â¬‡ï¸â¬‡ï¸ ì—¬ê¸°ì— ë³¸ì¸ì˜ Firebase ì„¤ì •ê°’ì„ ë„£ìœ¼ì„¸ìš”! â¬‡ï¸â¬‡ï¸â¬‡ï¸
        // 
        // ğŸ“Œ ì„¤ì •ê°’ ì°¾ëŠ” ë°©ë²•:
        // 1. https://console.firebase.google.com ì ‘ì†
        // 2. í”„ë¡œì íŠ¸ í´ë¦­
        // 3. í†±ë‹ˆë°”í€´(âš™ï¸) â†’ í”„ë¡œì íŠ¸ ì„¤ì •
        // 4. ì•„ë˜ë¡œ ìŠ¤í¬ë¡¤ â†’ "ë‚´ ì•±" ì„¹ì…˜
        // 5. "êµ¬ì„±" ì„ íƒ â†’ ì•„ë˜ ê°’ë“¤ ë³µì‚¬
        //
        const firebaseConfig = {
            apiKey: "AIzaSyCc3ZkW1rg42pzQ74kp4gkWI66IVrDweTo",                    // â† ë³¸ì¸ ê°’ìœ¼ë¡œ êµì²´
            authDomain: "supermrio-b454c.firebaseapp.com",              // â† ë³¸ì¸ ê°’ìœ¼ë¡œ êµì²´
            databaseURL: "https://console.firebase.google.com/project/supermrio-b454c/database/supermrio-b454c-default-rtdb/data?hl=ko&fb_gclid=EAIaIQobChMI5rfLx-aMkQMVB_tMAh1NjCSbEAAYASAAEgK3ZvD_BwE",  // â† ë³¸ì¸ ê°’ìœ¼ë¡œ êµì²´ (ì¤‘ìš”!)
            projectId: "supermrio-b454c",                               // â† ë³¸ì¸ ê°’ìœ¼ë¡œ êµì²´
            storageBucket: "supermrio-b454c.firebasestorage.app",               // â† ë³¸ì¸ ê°’ìœ¼ë¡œ êµì²´
            messagingSenderId: "1031587717506",                        // â† ë³¸ì¸ ê°’ìœ¼ë¡œ êµì²´
            appId: "1:1031587717506:web:0bb68070e9ee1bb74a6f9b"               // â† ë³¸ì¸ ê°’ìœ¼ë¡œ êµì²´
        };
        // â¬†ï¸â¬†ï¸â¬†ï¸ ìœ„ì˜ ê°’ë“¤ì„ ëª¨ë‘ ë³¸ì¸ Firebase ê°’ìœ¼ë¡œ ë°”ê¾¸ì„¸ìš”! â¬†ï¸â¬†ï¸â¬†ï¸

        // Firebase ì´ˆê¸°í™”
        let app, auth, database;
        let currentUser = null;
        let isGuest = false;

        try {
            app = firebase.initializeApp(firebaseConfig);
            auth = firebase.auth();
            database = firebase.database();
        } catch (e) {
            console.log("Firebase ì´ˆê¸°í™” ì‹¤íŒ¨ - ë°ëª¨ ëª¨ë“œë¡œ ì‹¤í–‰");
        }

        // ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ ê¸°ë°˜ ë°ëª¨ ë°ì´í„°
        let localScores = JSON.parse(localStorage.getItem('marioScores') || '[]');
        let myBestScore = parseInt(localStorage.getItem('myBestScore') || '0');

        // ì¸ì¦ í•¨ìˆ˜ë“¤
        async function login() {
            const email = document.getElementById('emailInput').value;
            const password = document.getElementById('passwordInput').value;
            
            if (!email || !password) {
                showAuthMessage('ì´ë©”ì¼ê³¼ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”');
                return;
            }

            try {
                if (auth) {
                    await auth.signInWithEmailAndPassword(email, password);
                    currentUser = auth.currentUser;
                    isGuest = false;
                    showMenu();
                } else {
                    // ë°ëª¨ ëª¨ë“œ
                    currentUser = { email: email, displayName: email.split('@')[0] };
                    isGuest = false;
                    localStorage.setItem('demoUser', JSON.stringify(currentUser));
                    showMenu();
                }
            } catch (error) {
                showAuthMessage('ë¡œê·¸ì¸ ì‹¤íŒ¨: ' + error.message);
            }
        }

        async function register() {
            const email = document.getElementById('emailInput').value;
            const password = document.getElementById('passwordInput').value;
            
            if (!email || !password) {
                showAuthMessage('ì´ë©”ì¼ê³¼ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”');
                return;
            }

            if (password.length < 6) {
                showAuthMessage('ë¹„ë°€ë²ˆí˜¸ëŠ” 6ì ì´ìƒì´ì–´ì•¼ í•©ë‹ˆë‹¤');
                return;
            }

            try {
                if (auth) {
                    await auth.createUserWithEmailAndPassword(email, password);
                    currentUser = auth.currentUser;
                    isGuest = false;
                    showAuthMessage('íšŒì›ê°€ì… ì„±ê³µ!', 'green');
                    setTimeout(() => showMenu(), 1000);
                } else {
                    // ë°ëª¨ ëª¨ë“œ
                    currentUser = { email: email, displayName: email.split('@')[0] };
                    isGuest = false;
                    localStorage.setItem('demoUser', JSON.stringify(currentUser));
                    showAuthMessage('íšŒì›ê°€ì… ì„±ê³µ! (ë°ëª¨ ëª¨ë“œ)', 'green');
                    setTimeout(() => showMenu(), 1000);
                }
            } catch (error) {
                showAuthMessage('íšŒì›ê°€ì… ì‹¤íŒ¨: ' + error.message);
            }
        }

        function guestLogin() {
            currentUser = { email: 'guest@mario.com', displayName: 'Guest_' + Math.random().toString(36).substr(2, 5) };
            isGuest = true;
            showMenu();
        }

        function logout() {
            if (auth) {
                auth.signOut();
            }
            currentUser = null;
            isGuest = false;
            localStorage.removeItem('demoUser');
            showScreen('loginScreen');
        }

        function showAuthMessage(msg, color = 'red') {
            const el = document.getElementById('authMessage');
            el.textContent = msg;
            el.style.color = color === 'green' ? '#2E7D32' : '#8B0000';
        }

        // í™”ë©´ ì „í™˜ í•¨ìˆ˜ë“¤
        function showScreen(screenId) {
            document.querySelectorAll('[id$="Screen"]').forEach(el => el.classList.add('hidden'));
            document.getElementById(screenId).classList.remove('hidden');
        }

        function showMenu() {
            showScreen('menuScreen');
            const name = currentUser?.displayName || currentUser?.email?.split('@')[0] || 'Player';
            document.getElementById('welcomeText').textContent = `í™˜ì˜í•©ë‹ˆë‹¤, ${name}!`;
            document.getElementById('myBestScore').textContent = myBestScore;
            loadMyBestScore();
        }

        async function loadMyBestScore() {
            if (database && currentUser && !isGuest) {
                try {
                    const snapshot = await database.ref('scores/' + currentUser.uid).once('value');
                    if (snapshot.val()) {
                        myBestScore = snapshot.val().score || 0;
                        document.getElementById('myBestScore').textContent = myBestScore;
                    }
                } catch (e) {
                    console.log('ì ìˆ˜ ë¡œë“œ ì‹¤íŒ¨');
                }
            }
        }

        async function showLeaderboard() {
            showScreen('leaderboardScreen');
            const listEl = document.getElementById('leaderboardList');
            listEl.innerHTML = '<p class="text-xs text-center">ë¡œë”©ì¤‘...</p>';

            let scores = [];

            if (database) {
                try {
                    const snapshot = await database.ref('leaderboard').orderByChild('score').limitToLast(10).once('value');
                    snapshot.forEach(child => {
                        scores.push(child.val());
                    });
                    scores.reverse();
                } catch (e) {
                    scores = localScores.sort((a, b) => b.score - a.score).slice(0, 10);
                }
            } else {
                scores = localScores.sort((a, b) => b.score - a.score).slice(0, 10);
            }

            if (scores.length === 0) {
                listEl.innerHTML = '<p class="text-xs text-center">ì•„ì§ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤</p>';
                return;
            }

            listEl.innerHTML = scores.map((s, i) => `
                <div class="bg-white pixel-border p-3 flex justify-between items-center text-xs">
                    <span class="${i < 3 ? 'text-yellow-600' : ''}">${i === 0 ? 'ğŸ¥‡' : i === 1 ? 'ğŸ¥ˆ' : i === 2 ? 'ğŸ¥‰' : (i + 1) + '.'} ${s.name}</span>
                    <span class="text-red-600">${s.score}</span>
                </div>
            `).join('');
        }

        function showHowToPlay() {
            showScreen('howToPlayScreen');
        }

        // ê²Œì„ ë³€ìˆ˜ë“¤
        let canvas, ctx;
        let gameLoop;
        let score = 0;
        let coins = 0;
        let lives = 3;
        let gameRunning = false;
        let cameraX = 0;

        // ë§ˆë¦¬ì˜¤ ê°ì²´
        const mario = {
            x: 100,
            y: 300,
            width: 32,
            height: 40,
            vx: 0,
            vy: 0,
            jumping: false,
            grounded: false,
            facing: 1,
            frame: 0
        };

        // ê²Œì„ ìš”ì†Œë“¤
        let platforms = [];
        let enemies = [];
        let coinItems = [];
        let clouds = [];

        // ì…ë ¥ ìƒíƒœ
        const keys = {
            left: false,
            right: false,
            jump: false
        };

        // ê²Œì„ ìƒìˆ˜
        const GRAVITY = 0.6;
        const JUMP_FORCE = -14;
        const MOVE_SPEED = 5;
        const GROUND_Y = 350;

        function startGame() {
            showScreen('gameScreen');
            canvas = document.getElementById('gameCanvas');
            ctx = canvas.getContext('2d');
            
            // ê²Œì„ ì´ˆê¸°í™”
            score = 0;
            coins = 0;
            lives = 3;
            cameraX = 0;
            gameRunning = true;
            
            mario.x = 100;
            mario.y = 300;
            mario.vx = 0;
            mario.vy = 0;
            mario.jumping = false;
            mario.grounded = false;
            
            generateLevel();
            updateUI();
            
            if (gameLoop) cancelAnimationFrame(gameLoop);
            gameLoop = requestAnimationFrame(update);
        }

        function generateLevel() {
            platforms = [];
            enemies = [];
            coinItems = [];
            clouds = [];
            
            // ê¸°ë³¸ ë°”ë‹¥
            for (let i = 0; i < 100; i++) {
                // ëœë¤í•˜ê²Œ êµ¬ë© ìƒì„±
                if (i > 10 && Math.random() < 0.1 && i % 5 === 0) {
                    continue; // êµ¬ë©
                }
                platforms.push({
                    x: i * 80,
                    y: GROUND_Y,
                    width: 80,
                    height: 50,
                    type: 'ground'
                });
            }
            
            // í”Œë«í¼ ìƒì„±
            for (let i = 0; i < 50; i++) {
                if (Math.random() < 0.3) {
                    const px = 400 + i * 300 + Math.random() * 200;
                    const py = 200 + Math.random() * 100;
                    platforms.push({
                        x: px,
                        y: py,
                        width: 100 + Math.random() * 50,
                        height: 20,
                        type: 'brick'
                    });
                    
                    // í”Œë«í¼ ìœ„ì— ì½”ì¸
                    if (Math.random() < 0.7) {
                        coinItems.push({
                            x: px + 40,
                            y: py - 40,
                            collected: false
                        });
                    }
                }
            }
            
            // ë°”ë‹¥ ìœ„ ì½”ì¸
            for (let i = 0; i < 80; i++) {
                if (Math.random() < 0.4) {
                    coinItems.push({
                        x: 300 + i * 150 + Math.random() * 100,
                        y: GROUND_Y - 60 - Math.random() * 50,
                        collected: false
                    });
                }
            }
            
            // ì  ìƒì„±
            for (let i = 0; i < 40; i++) {
                enemies.push({
                    x: 600 + i * 400 + Math.random() * 200,
                    y: GROUND_Y - 30,
                    width: 32,
                    height: 30,
                    vx: -1.5,
                    alive: true,
                    frame: 0
                });
            }
            
            // êµ¬ë¦„
            for (let i = 0; i < 30; i++) {
                clouds.push({
                    x: i * 400 + Math.random() * 300,
                    y: 30 + Math.random() * 80,
                    size: 40 + Math.random() * 30
                });
            }
        }

        function update() {
            if (!gameRunning) return;
            
            // ì…ë ¥ ì²˜ë¦¬
            if (keys.left) mario.vx = -MOVE_SPEED;
            else if (keys.right) mario.vx = MOVE_SPEED;
            else mario.vx *= 0.8;
            
            if (keys.jump && mario.grounded && !mario.jumping) {
                mario.vy = JUMP_FORCE;
                mario.jumping = true;
                mario.grounded = false;
            }
            
            // ë¬¼ë¦¬
            mario.vy += GRAVITY;
            mario.x += mario.vx;
            mario.y += mario.vy;
            
            // ë°©í–¥
            if (mario.vx > 0.5) mario.facing = 1;
            else if (mario.vx < -0.5) mario.facing = -1;
            
            // ì¹´ë©”ë¼ ì¶”ì 
            if (mario.x - cameraX > 350) cameraX = mario.x - 350;
            if (mario.x - cameraX < 150) cameraX = Math.max(0, mario.x - 150);
            
            // ì ìˆ˜ (ê±°ë¦¬ ê¸°ë°˜)
            const newScore = Math.max(score, Math.floor((mario.x - 100) / 10));
            if (newScore > score) {
                score = newScore;
                updateUI();
            }
            
            // ì¶©ëŒ ê²€ì‚¬
            mario.grounded = false;
            
            for (const p of platforms) {
                if (checkCollision(mario, p)) {
                    // ìœ„ì—ì„œ ì°©ì§€
                    if (mario.vy > 0 && mario.y + mario.height - mario.vy <= p.y + 10) {
                        mario.y = p.y - mario.height;
                        mario.vy = 0;
                        mario.grounded = true;
                        mario.jumping = false;
                    }
                    // ì•„ë˜ì—ì„œ ì¶©ëŒ
                    else if (mario.vy < 0 && mario.y - mario.vy >= p.y + p.height - 10) {
                        mario.y = p.y + p.height;
                        mario.vy = 0;
                    }
                    // ì˜†ì—ì„œ ì¶©ëŒ
                    else {
                        if (mario.vx > 0) mario.x = p.x - mario.width;
                        else if (mario.vx < 0) mario.x = p.x + p.width;
                        mario.vx = 0;
                    }
                }
            }
            
            // ì½”ì¸ ìˆ˜ì§‘
            for (const coin of coinItems) {
                if (!coin.collected && checkCollision(mario, { x: coin.x, y: coin.y, width: 24, height: 24 })) {
                    coin.collected = true;
                    coins++;
                    score += 10;
                    updateUI();
                }
            }
            
            // ì  ì²˜ë¦¬
            for (const enemy of enemies) {
                if (!enemy.alive) continue;
                
                enemy.x += enemy.vx;
                enemy.frame = (enemy.frame + 0.1) % 2;
                
                // í™”ë©´ ë°–ìœ¼ë¡œ ë‚˜ê°€ë©´ ë°©í–¥ ì „í™˜
                if (enemy.x < cameraX - 100) enemy.vx = 1.5;
                if (enemy.x > cameraX + 900) enemy.vx = -1.5;
                
                if (checkCollision(mario, enemy)) {
                    // ìœ„ì—ì„œ ë°Ÿê¸°
                    if (mario.vy > 0 && mario.y + mario.height - mario.vy < enemy.y + 10) {
                        enemy.alive = false;
                        mario.vy = JUMP_FORCE * 0.6;
                        score += 50;
                        updateUI();
                    } else {
                        // í”¼í•´ ë°›ìŒ
                        takeDamage();
                    }
                }
            }
            
            // êµ¬ë©ì´ ì¶”ë½
            if (mario.y > 500) {
                lives = 0;
                gameOver();
                return;
            }
            
            // ì™¼ìª½ ê²½ê³„
            if (mario.x < cameraX) mario.x = cameraX;
            
            // ê·¸ë¦¬ê¸°
            draw();
            
            gameLoop = requestAnimationFrame(update);
        }

        function checkCollision(a, b) {
            return a.x < b.x + b.width &&
                   a.x + a.width > b.x &&
                   a.y < b.y + b.height &&
                   a.y + a.height > b.y;
        }

        function takeDamage() {
            lives--;
            updateUI();
            
            if (lives <= 0) {
                gameOver();
            } else {
                // ë¬´ì  ì‹œê°„ & ìœ„ì¹˜ ë¦¬ì…‹
                mario.x = Math.max(100, cameraX + 100);
                mario.y = 200;
                mario.vy = 0;
            }
        }

        function draw() {
            // í•˜ëŠ˜ ë°°ê²½
            ctx.fillStyle = '#5c94fc';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            // êµ¬ë¦„
            ctx.fillStyle = 'white';
            for (const cloud of clouds) {
                const cx = cloud.x - cameraX;
                if (cx > -100 && cx < 900) {
                    drawCloud(cx, cloud.y, cloud.size);
                }
            }
            
            // í”Œë«í¼
            for (const p of platforms) {
                const px = p.x - cameraX;
                if (px > -100 && px < 900) {
                    if (p.type === 'ground') {
                        // ì”ë””
                        ctx.fillStyle = '#4CAF50';
                        ctx.fillRect(px, p.y, p.width, 10);
                        // í™
                        ctx.fillStyle = '#8B4513';
                        ctx.fillRect(px, p.y + 10, p.width, p.height - 10);
                    } else {
                        // ë²½ëŒ
                        ctx.fillStyle = '#D2691E';
                        ctx.fillRect(px, p.y, p.width, p.height);
                        ctx.strokeStyle = '#8B4513';
                        ctx.lineWidth = 2;
                        ctx.strokeRect(px, p.y, p.width, p.height);
                        // ë²½ëŒ ë¬´ëŠ¬
                        ctx.beginPath();
                        ctx.moveTo(px + p.width/2, p.y);
                        ctx.lineTo(px + p.width/2, p.y + p.height);
                        ctx.stroke();
                    }
                }
            }
            
            // ì½”ì¸
            for (const coin of coinItems) {
                if (coin.collected) continue;
                const cx = coin.x - cameraX;
                if (cx > -50 && cx < 850) {
                    ctx.fillStyle = '#FFD700';
                    ctx.beginPath();
                    ctx.arc(cx + 12, coin.y + 12, 12, 0, Math.PI * 2);
                    ctx.fill();
                    ctx.fillStyle = '#FFA500';
                    ctx.beginPath();
                    ctx.arc(cx + 12, coin.y + 12, 8, 0, Math.PI * 2);
                    ctx.fill();
                }
            }
            
            // ì  (êµ¼ë°”)
            for (const enemy of enemies) {
                if (!enemy.alive) continue;
                const ex = enemy.x - cameraX;
                if (ex > -50 && ex < 850) {
                    drawGoomba(ex, enemy.y, enemy.frame);
                }
            }
            
            // ë§ˆë¦¬ì˜¤
            drawMario(mario.x - cameraX, mario.y);
        }

        function drawCloud(x, y, size) {
            ctx.fillStyle = 'white';
            ctx.beginPath();
            ctx.arc(x, y + size/2, size/2, 0, Math.PI * 2);
            ctx.arc(x + size/2, y + size/3, size/2.5, 0, Math.PI * 2);
            ctx.arc(x + size, y + size/2, size/2, 0, Math.PI * 2);
            ctx.fill();
        }

        function drawMario(x, y) {
            ctx.save();
            
            if (mario.facing === -1) {
                ctx.translate(x + mario.width, y);
                ctx.scale(-1, 1);
                x = 0;
                y = 0;
            }
            
            // ëª¨ì
            ctx.fillStyle = '#e52521';
            ctx.fillRect(x + 4, y, 24, 8);
            ctx.fillRect(x, y + 8, 32, 8);
            
            // ì–¼êµ´
            ctx.fillStyle = '#ffc0a0';
            ctx.fillRect(x + 4, y + 12, 20, 12);
            
            // ëˆˆ
            ctx.fillStyle = 'black';
            ctx.fillRect(x + 8, y + 14, 4, 4);
            
            // ëª¸
            ctx.fillStyle = '#e52521';
            ctx.fillRect(x + 4, y + 24, 24, 8);
            
            // ë°”ì§€
            ctx.fillStyle = '#0000ff';
            ctx.fillRect(x + 4, y + 32, 10, 8);
            ctx.fillRect(x + 18, y + 32, 10, 8);
            
            ctx.restore();
        }

        function drawGoomba(x, y, frame) {
            // ëª¸í†µ
            ctx.fillStyle = '#8B4513';
            ctx.beginPath();
            ctx.ellipse(x + 16, y + 15, 14, 12, 0, 0, Math.PI * 2);
            ctx.fill();
            
            // ëˆˆ
            ctx.fillStyle = 'white';
            ctx.beginPath();
            ctx.ellipse(x + 10, y + 10, 4, 5, 0, 0, Math.PI * 2);
            ctx.ellipse(x + 22, y + 10, 4, 5, 0, 0, Math.PI * 2);
            ctx.fill();
            
            ctx.fillStyle = 'black';
            ctx.beginPath();
            ctx.arc(x + 10, y + 11, 2, 0, Math.PI * 2);
            ctx.arc(x + 22, y + 11, 2, 0, Math.PI * 2);
            ctx.fill();
            
            // ë°œ
            ctx.fillStyle = '#654321';
            const footOffset = Math.floor(frame) * 3;
            ctx.fillRect(x + 4 + footOffset, y + 24, 8, 6);
            ctx.fillRect(x + 20 - footOffset, y + 24, 8, 6);
        }

        function updateUI() {
            document.getElementById('scoreDisplay').textContent = score;
            document.getElementById('coinDisplay').textContent = coins;
            document.getElementById('lifeDisplay').textContent = lives;
        }

        async function gameOver() {
            gameRunning = false;
            cancelAnimationFrame(gameLoop);
            
            const finalScore = score + coins * 10;
            document.getElementById('finalScore').textContent = finalScore;
            document.getElementById('finalCoins').textContent = coins;
            
            // ìµœê³  ì ìˆ˜ ê°±ì‹ 
            if (finalScore > myBestScore) {
                myBestScore = finalScore;
                localStorage.setItem('myBestScore', myBestScore);
            }
            
            // ì ìˆ˜ ì €ì¥
            await saveScore(finalScore);
            
            showScreen('gameOverScreen');
        }

        async function saveScore(finalScore) {
            const name = currentUser?.displayName || currentUser?.email?.split('@')[0] || 'Guest';
            const scoreData = {
                name: name,
                score: finalScore,
                coins: coins,
                timestamp: Date.now()
            };
            
            // ë¡œì»¬ ì €ì¥
            localScores.push(scoreData);
            localScores.sort((a, b) => b.score - a.score);
            localScores = localScores.slice(0, 100);
            localStorage.setItem('marioScores', JSON.stringify(localScores));
            
            // Firebase ì €ì¥
            if (database && currentUser && !isGuest) {
                try {
                    // ê°œì¸ ìµœê³  ì ìˆ˜
                    const userRef = database.ref('scores/' + currentUser.uid);
                    const snapshot = await userRef.once('value');
                    const currentBest = snapshot.val()?.score || 0;
                    
                    if (finalScore > currentBest) {
                        await userRef.set(scoreData);
                    }
                    
                    // ë¦¬ë”ë³´ë“œ
                    await database.ref('leaderboard').push(scoreData);
                } catch (e) {
                    console.log('ì ìˆ˜ ì €ì¥ ì‹¤íŒ¨:', e);
                }
            }
        }

        // í‚¤ë³´ë“œ ì…ë ¥
        document.addEventListener('keydown', (e) => {
            if (e.code === 'ArrowLeft' || e.code === 'KeyA') keys.left = true;
            if (e.code === 'ArrowRight' || e.code === 'KeyD') keys.right = true;
            if (e.code === 'Space' || e.code === 'ArrowUp' || e.code === 'KeyW') {
                e.preventDefault();
                keys.jump = true;
            }
        });

        document.addEventListener('keyup', (e) => {
            if (e.code === 'ArrowLeft' || e.code === 'KeyA') keys.left = false;
            if (e.code === 'ArrowRight' || e.code === 'KeyD') keys.right = false;
            if (e.code === 'Space' || e.code === 'ArrowUp' || e.code === 'KeyW') keys.jump = false;
        });

        // ëª¨ë°”ì¼ í„°ì¹˜ ì…ë ¥
        document.getElementById('leftBtn')?.addEventListener('touchstart', (e) => { e.preventDefault(); keys.left = true; });
        document.getElementById('leftBtn')?.addEventListener('touchend', () => keys.left = false);
        document.getElementById('rightBtn')?.addEventListener('touchstart', (e) => { e.preventDefault(); keys.right = true; });
        document.getElementById('rightBtn')?.addEventListener('touchend', () => keys.right = false);
        document.getElementById('jumpBtn')?.addEventListener('touchstart', (e) => { e.preventDefault(); keys.jump = true; });
        document.getElementById('jumpBtn')?.addEventListener('touchend', () => keys.jump = false);

        // ë§ˆìš°ìŠ¤/í„°ì¹˜ ë²„íŠ¼ ì§€ì›
        document.getElementById('leftBtn')?.addEventListener('mousedown', () => keys.left = true);
        document.getElementById('leftBtn')?.addEventListener('mouseup', () => keys.left = false);
        document.getElementById('rightBtn')?.addEventListener('mousedown', () => keys.right = true);
        document.getElementById('rightBtn')?.addEventListener('mouseup', () => keys.right = false);
        document.getElementById('jumpBtn')?.addEventListener('mousedown', () => keys.jump = true);
        document.getElementById('jumpBtn')?.addEventListener('mouseup', () => keys.jump = false);

        // ìë™ ë¡œê·¸ì¸ í™•ì¸
        window.onload = () => {
            // ì €ì¥ëœ ë°ëª¨ ì‚¬ìš©ì í™•ì¸
            const savedUser = localStorage.getItem('demoUser');
            if (savedUser) {
                currentUser = JSON.parse(savedUser);
                showMenu();
            }
            
            // Firebase ì¸ì¦ ìƒíƒœ í™•ì¸
            if (auth) {
                auth.onAuthStateChanged((user) => {
                    if (user) {
                        currentUser = user;
                        showMenu();
                    }
                });
            }
        };
    </script>
</body>
</html>
